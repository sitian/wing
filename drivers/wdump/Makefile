CONFIG=src/config.h

ifneq ($(KERNELRELEASE),)
# call from kernel build system

obj-m	:= wdump.o
wdump-objs := src/save.o src/restore.o src/ckpt.o src/util.o src/sys.o src/debug.o src/util.o src/io.o src/conn.o src/dump.o

else

KERNELDIR ?= /lib/modules/$(shell uname -r)/build
PWD       := $(shell pwd)

all:
	make config
	make modules

modules:
	echo $(MAKE) -C $(KERNELDIR) M=$(PWD) modules
	$(MAKE) -C $(KERNELDIR) M=$(PWD) modules
endif

help:
	@echo "make OPTIONS: modules help docs clean build"

config:
	rm -f $(CONFIG)
	echo "// generated by mk-config" >> $(CONFIG)
	echo >> $(CONFIG)
	./mk-config arch_pick_mmap_layout ARCH_PICK_MMAP_LAYOUT >> $(CONFIG)
	./mk-config copy_siginfo_to_user COPY_SIGINFO_TO_USER >> $(CONFIG)
	./mk-config do_sigaction DO_SIGACTION >> $(CONFIG)
	./mk-config group_send_sig_info GROUP_SEND_SIG_INFO >> $(CONFIG)
	./mk-config handle_mm_fault HANDLE_MM_FAULT >> $(CONFIG)
	./mk-config sys_setgroups SYS_SETGROUPS >> $(CONFIG)
	./mk-config sys_setresgid SYS_SETRESGID >> $(CONFIG)
	./mk-config sys_setresuid SYS_SETRESUID >> $(CONFIG)
	./mk-config sys_mprotect SYS_MPROTECT >> $(CONFIG)
	./mk-config sys_prctl SYS_PRCTL >> $(CONFIG)
	./mk-config set_dumpable SET_DUMPABLE >> $(CONFIG)
	./mk-config find_task_by_vpid FIND_TASK_BY_VPID >> $(CONFIG)
	./mk-config flush_tlb_page FLUSH_TLB_PAGE >> $(CONFIG)
	./mk-config set_fs_pwd SET_FS_PWD >> $(CONFIG)
	./mk-config set_fs_root SET_FS_ROOT >> $(CONFIG)
	./mk-config do_mmap_pgoff DO_MMAP_PGOFF >> $(CONFIG)
	./mk-config do_munmap DO_MUNMAP >> $(CONFIG)
	./mk-config tasklist_lock TASKLIST_LOCK >> $(CONFIG)
	./mk-config suid_dumpable SUID_DUMPABLE >> $(CONFIG)
	./mk-config sys_mremap SYS_MREMAP >> $(CONFIG)
	./mk-config arch_setup_additional_pages ARCH_SETUP_ADDITIONAL_PAGES >> $(CONFIG)
	./mk-config sys_lseek SYS_LSEEK >> $(CONFIG)
	./mk-config groups_search GROUPS_SEARCH >> $(CONFIG)
	
docs:
	doxygen Doxyfile

clean:
	rm -rf src/*.o *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions Module.symvers \
	modules.order html config.h

depend .depend dep:
	$(CC) $(CFLAGS) -M *.c > .depend

ifeq (.depend,$(wildcard .depend))
include .depend
endif
